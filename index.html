<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simple SPC Tool (Run & XmR)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Annotation script -->
 <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
   <!-- PDF export script -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script> 

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 1.5rem;
      background-color: #f0f4f5; /* light NHS-style background */
      max-width: 100%;
    }
    h1 {
      margin-bottom: 0.25rem;
	color: #005eb8; /* NHS blue */
    }
    .sub {
      margin-top: 0;
      color: #555;
      font-size: 0.9rem;
    }
  .panel {
  padding: 1rem;
  border-radius: 0.5rem;
  border: 1px solid #d8dde0;
  background: #ffffff;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  margin-bottom: 1.5rem;
}
    label {
      display: inline-block;
      margin-right: 0.5rem;
      margin-top: 0.5rem;
    }
    select, input[type="file"], button {
      margin-top: 0.25rem;
      margin-bottom: 0.5rem;
    }
    /* Buttons */
button {
  padding: 0.45rem 0.9rem;
  border-radius: 9999px;
  border: 1px solid #005eb8;
  background: #005eb8;
  color: #ffffff;
  cursor: pointer;
  font-size: 0.9rem;
}

button:hover:not(:disabled) {
  background: #003f87;
  border-color: #003f87;
}

button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
    /* Make the main I/XmR chart tall and prominent */
.chart-container {
  width: 100%;
  height: 480px;          /* bigger, clearer */
  overflow: hidden;
}

/* MR chart a bit shorter */
#mrPanel .chart-container {
  height: 300px;
}
    .hint {
      font-size: 0.8rem;
      color: #666;
    }
    .error {
      color: #b00020;
      font-size: 0.9rem;
    }

.layout {
  display: flex;
  gap: 2rem;
  align-items: flex-start;
  max-width: 1400px;
  margin: 0 auto;
  padding: 0.5rem 0;
}

/* Sidebar with controls */
.sidebar {
  width: 320px;
  flex-shrink: 0;
  position: sticky;
  top: 1rem;
}

.sidebar input,
.sidebar select,
.sidebar textarea {
  width: 100%;
  box-sizing: border-box;
  margin-bottom: 0.6rem;
}

/* Main area with charts/summary */
.main {
  flex: 1;
  min-width: 0; /* prevents overflow */
}

/* Collapsible section styling */
.sidebar details {
  margin-bottom: 1rem;
}
.sidebar summary {
  font-weight: 600;
  cursor: pointer;
  padding: 0.25rem 0;
  color: #003087;
}
.sidebar summary::-webkit-details-marker {
  margin-right: 0.25rem;
}

.sidebar label {
  display: block;
  margin-bottom: 0.25rem;
}

.sidebar input[type="text"],
.sidebar input[type="date"],
.sidebar input[type="number"],
.sidebar select {
  margin-bottom: 0.75rem;
}

canvas {
  display: block;
  max-width: 100%;
  max-height: 100%;
}

/* Toggle button */
.sidebar-toggle {
  margin-bottom: 0.5rem;
  padding: 0.35rem 0.9rem;
  border-radius: 9999px;
  border: 1px solid #005eb8;
  background: #005eb8;
  color: #ffffff;
  cursor: pointer;
  font-size: 0.85rem;
}

/* Slightly smaller than primary buttons so it feels like a utility */
.sidebar-toggle:hover {
  background: #003f87;
  border-color: #003f87;
}

/* When collapsed, slide the sidebar off to the left and let main fill space */
.layout.sidebar-collapsed .sidebar {
  transform: translateX(-110%);
  opacity: 0;
  pointer-events: none;
  position: absolute;
}

.layout.sidebar-collapsed .main {
  flex: 1 1 100%;
}

/* Smooth transition */
.sidebar {
  transition: transform 0.2s ease-out, opacity 0.2s ease-out;
}

/* Responsive: stack sidebar on top for narrow screens */
@media (max-width: 1000px) {
  .layout {
    flex-direction: column;
  }
  .sidebar {
    position: static;
    width: 100%;
  }
}

  </style>
</head>

<body>
  <h1>Simple SPC Web Tool</h1>
  <p class="sub">Upload a CSV and create SPC charts in your browser.</p>

<button id="toggleSidebarButton" class="sidebar-toggle">
  Hide controls
</button>

<div class="layout">
    <!-- SIDEBAR: all controls -->
    <aside class="sidebar">

<!-- Section 1: Data upload & columns -->
      <details open>
        <summary>1. Data & columns</summary>
	<div class="panel">

    <div>
      <label for="fileInput"><strong>1. Upload CSV file:</strong></label><br />
      <input type="file" id="fileInput" accept=".csv" />
      <div class="hint">
        Expected columns: a date/time column (e.g. <code>Date</code>) and a numeric column (e.g. <code>Value</code>).
      </div>
    </div>

    <div id="columnSelectors" style="display: none;">
      <hr />
      <strong>Choose columns:</strong><br />

      <label>Date column:
        <select id="dateColumn"></select>
      </label>

      <label>Value column:
        <select id="valueColumn"></select>
      </label>

      <br />
      <strong>Chart type:</strong><br />
      <label>
        <input type="radio" name="chartType" value="run" checked />
        Run chart (median only)
      </label>
      <label>
        <input type="radio" name="chartType" value="xmr" />
        XmR chart (mean + control limits)
      </label>

      	<br />
	</div>
      	</details>


	<!-- Section 2: Titles & labels -->
        <details open>
        <summary>2. Titles & labels</summary>
        <div class="panel">
	<div>
  	<label>
    	Chart title:
    	<input type="text" id="chartTitle" placeholder="e.g. I-MR Chart â€“ Demonstration data" style="width: 16rem;" />
  	</label>
	</div>
	<div>
  	<label>
    	X-axis label:
   	 <input type="text" id="xAxisLabel" placeholder="Date" style="width: 16rem;" />
 	 </label>
	</div>
	<div>
  	<label>
   	 Y-axis label:
    	<input type="text" id="yAxisLabel" placeholder="Example metric" style="width: 16rem;" />
 	 </label>
	</div>
	</div>
      </details>

	<!-- Section 3: Target & capability -->
      <details open>
        <summary>3. Target & capability</summary>
        <div class="panel">
	<div>
	  <label>
	    Target / goal value:
	    <input type="number" id="targetValue" step="any" placeholder="e.g. 30" style="width: 10rem;" />
	  </label>
	  <div class="hint">
	    If set, a dashed orange target line will be drawn across the chart.
	  </div>
	</div>
	<div>
	  <label>
	    Target direction:
	    <select id="targetDirection">
	      <option value="above">At or above target is good</option>
	      <option value="below">At or below target is good</option>
	    </select>
	  </label>
	</div>
 	</div>
      </details>

	<!-- Section 4: Annotations -->
      	<details>
        <summary>4. Annotations</summary>
        <div class="panel">
	<div>
  	<label>
   	 Annotation date:
   	 <input type="date" id="annotationDate" />
 	 </label>
	</div>
	<div>
 	 <label>
   	 Annotation label:
  	  <input type="text" id="annotationLabel" placeholder="e.g. New pathway introduced" style="width: 16rem;" />
 	 </label>
	</div>
	<button id="addAnnotationButton" type="button">Add annotation</button>
	<button id="clearAnnotationsButton" type="button" style="margin-left: 0.5rem;">
	 Clear all annotations
	</button>
	<div class="hint">
  	Annotations will appear as vertical dashed lines with labels on the chart.
	</div>
	 </div>
      </details>

      <!-- Section 5: Baseline & generate -->
      <details open>
        <summary>5. Baseline & generate</summary>
        <div class="panel">
      <label>
      Use first
      <input type="number" id="baselinePoints" min="2" step="1" style="width: 4rem;" />
      points as baseline for centre line and limits
     </label>
     <div class="hint">
      Leave blank to use <em>all</em> points to calculate the median/mean and limits.
     </div>

  	<br />	
      <button id="generateButton">Generate chart</button>
      <span class="hint">Data never leaves your browser.</span>
      <div id="errorMessage" class="error"></div>
    
   	</div>
      </details>

    </aside>

<!-- MAIN AREA: charts + analysis -->
    <main class="main">

	<div id="reportContent">  
	<div class="panel">
  	<strong>Chart:</strong>
  	<div class="chart-container">
    	<canvas id="spcChart"></canvas>
  	</div>

	<button id="downloadPngButton" style="margin-top: 0.5rem;">
  	Download chart as PNG
	</button>

	<button id="downloadPdfButton" style="margin-top: 0.5rem; margin-left: 0.5rem;">
  	Download PDF report
	</button>
	
	<div id="summary" style="margin-top: 1rem; font-size: 0.9rem;"></div>
	<div id="capability" style="margin-top: 1rem; font-size: 0.9rem;"></div>

  <div class="panel" id="mrPanel" style="display: none;">
  <strong>Moving Range chart:</strong>
  <div class="chart-container">
    <canvas id="mrChartCanvas"></canvas>
  </div>
  </div>
</main>
</div>
   <script src="spc.js"></script>
</body>
</html>
